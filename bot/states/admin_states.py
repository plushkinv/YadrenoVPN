"""
FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.

–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–º–∏ –¥–∏–∞–ª–æ–≥–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
"""
from aiogram.fsm.state import State, StatesGroup


class AdminStates(StatesGroup):
    """–°–æ—Å—Ç–æ—è–Ω–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏."""
    
    # ========== –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ==========
    admin_menu = State()  # –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –∞–¥–º–∏–Ω–∫–∏
    
    # ========== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞–º–∏ ==========
    servers_list = State()           # –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤
    server_view = State()            # –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
    
    # ========== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ (–ø–æ—à–∞–≥–æ–≤—ã–π –¥–∏–∞–ª–æ–≥) ==========
    add_server_name = State()        # –®–∞–≥ 1: –ù–∞–∑–≤–∞–Ω–∏–µ
    add_server_host = State()        # –®–∞–≥ 2: –•–æ—Å—Ç
    add_server_port = State()        # –®–∞–≥ 3: –ü–æ—Ä—Ç
    add_server_path = State()        # –®–∞–≥ 4: web_base_path
    add_server_login = State()       # –®–∞–≥ 5: –õ–æ–≥–∏–Ω
    add_server_password = State()    # –®–∞–≥ 6: –ü–∞—Ä–æ–ª—å
    add_server_confirm = State()     # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
    
    # ========== –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ ==========
    edit_server = State()            # –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º
    
    # ========== –£–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ ==========
    delete_server_confirm = State()  # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
    
    # ========== –†–∞–∑–¥–µ–ª ¬´–û–ø–ª–∞—Ç—ã¬ª ==========
    payments_menu = State()          # –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –æ–ø–ª–∞—Ç
    
    # ========== –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫—Ä–∏–ø—Ç–æ-–ø–ª–∞—Ç–µ–∂–µ–π ==========
    crypto_setup_url = State()       # –í–≤–æ–¥ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ç–æ–≤–∞—Ä
    crypto_setup_secret = State()    # –í–≤–æ–¥ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞
    edit_crypto = State()            # –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏–ø—Ç–æ-–Ω–∞—Å—Ç—Ä–æ–µ–∫
    
    # ========== –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤ ==========
    waiting_for_text = State()       # –û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞ –Ω–æ–≤–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
    
    # ========== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞–º–∏ ==========
    tariffs_list = State()           # –°–ø–∏—Å–æ–∫ —Ç–∞—Ä–∏—Ñ–æ–≤
    tariff_view = State()            # –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞
    
    # ========== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ (–ø–æ—à–∞–≥–æ–≤—ã–π –¥–∏–∞–ª–æ–≥) ==========
    add_tariff_name = State()        # –®–∞–≥ 1: –ù–∞–∑–≤–∞–Ω–∏–µ
    add_tariff_price_cents = State() # –®–∞–≥ 2: –¶–µ–Ω–∞ –≤ —Ü–µ–Ω—Ç–∞—Ö
    add_tariff_price_stars = State() # –®–∞–≥ 3: –¶–µ–Ω–∞ –≤ –∑–≤—ë–∑–¥–∞—Ö
    add_tariff_duration = State()    # –®–∞–≥ 4: –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    add_tariff_external_id = State() # –®–∞–≥ 5: ID —Ç–∞—Ä–∏—Ñ–∞ –≤ Ya.Seller (1-9)
    add_tariff_confirm = State()     # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    
    # ========== –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ ==========
    edit_tariff = State()            # –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º
    
    # ========== –†–∞—Å—Å—ã–ª–∫–∞ ==========
    broadcast_menu = State()         # –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω —Ä–∞—Å—Å—ã–ª–∫–∏
    broadcast_waiting_message = State()      # –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏
    broadcast_waiting_notify_days = State()  # –û–∂–∏–¥–∞–Ω–∏–µ —á–∏—Å–ª–∞ –¥–Ω–µ–π –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    broadcast_waiting_notify_text = State()  # –û–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    
    # ========== –†–∞–∑–¥–µ–ª ¬´–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏¬ª ==========
    users_menu = State()             # –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω —Ä–∞–∑–¥–µ–ª–∞
    users_list = State()             # –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
    user_view = State()              # –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    waiting_user_id = State()        # –û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞ telegram_id
    
    # ========== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ VPN-–∫–ª—é—á–æ–º ==========
    key_view = State()               # –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞
    key_extend_days = State()        # –í–≤–æ–¥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è
    key_change_traffic = State()     # –í–≤–æ–¥ –Ω–æ–≤–æ–≥–æ –ª–∏–º–∏—Ç–∞ —Ç—Ä–∞—Ñ–∏–∫–∞
    
    # ========== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º ==========
    add_key_server = State()         # –í—ã–±–æ—Ä —Å–µ—Ä–≤–µ—Ä–∞
    add_key_inbound = State()        # –í—ã–±–æ—Ä inbound (–ø—Ä–æ—Ç–æ–∫–æ–ª–∞)
    add_key_traffic = State()        # –í–≤–æ–¥ –ª–∏–º–∏—Ç–∞ —Ç—Ä–∞—Ñ–∏–∫–∞ (–ì–ë)
    add_key_days = State()           # –í–≤–æ–¥ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è (–¥–Ω–µ–π)
    add_key_confirm = State()        # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è


# ============================================================================
# –ü–ê–†–ê–ú–ï–¢–†–´ –°–ï–†–í–ï–†–û–í
# ============================================================================

SERVER_PARAMS = [
    {
        "key": "name",
        "label": "–ù–∞–∑–≤–∞–Ω–∏–µ",
        "hint": "–Ω–∞–ø—Ä–∏–º–µ—Ä: Server-DE, –ì–µ—Ä–º–∞–Ω–∏—è-1",
        "validate": lambda x: len(x) >= 2,
        "error": "–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞"
    },
    {
        "key": "host",
        "label": "–•–æ—Å—Ç",
        "hint": "IP-–∞–¥—Ä–µ—Å –∏–ª–∏ –¥–æ–º–µ–Ω (192.168.1.1 –∏–ª–∏ vpn.example.com)",
        "validate": lambda x: len(x) >= 4,
        "error": "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ö–æ—Å—Ç"
    },
    {
        "key": "port",
        "label": "–ü–æ—Ä—Ç",
        "hint": "–æ–±—ã—á–Ω–æ 2053 –∏–ª–∏ 2054",
        "validate": lambda x: x.isdigit() and 1 <= int(x) <= 65535,
        "error": "–ü–æ—Ä—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º –æ—Ç 1 –¥–æ 65535",
        "convert": int
    },
    {
        "key": "web_base_path",
        "label": "–ü—É—Ç—å API",
        "hint": "—Å–µ–∫—Ä–µ—Ç–Ω—ã–π –ø—É—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä: /abc123secret/)",
        "validate": lambda x: len(x) >= 1,
        "error": "–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å API"
    },
    {
        "key": "login",
        "label": "–õ–æ–≥–∏–Ω",
        "hint": "–ª–æ–≥–∏–Ω –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –ø–∞–Ω–µ–ª—å",
        "validate": lambda x: len(x) >= 1,
        "error": "–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω"
    },
    {
        "key": "password",
        "label": "–ü–∞—Ä–æ–ª—å",
        "hint": "–ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –ø–∞–Ω–µ–ª—å",
        "validate": lambda x: len(x) >= 1,
        "error": "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
    },
]


def get_param_by_index(index: int) -> dict:
    """–ü–æ–ª—É—á–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ –∏–Ω–¥–µ–∫—Å—É."""
    if 0 <= index < len(SERVER_PARAMS):
        return SERVER_PARAMS[index]
    return SERVER_PARAMS[0]


def get_total_params() -> int:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞."""
    return len(SERVER_PARAMS)


# ============================================================================
# –ü–ê–†–ê–ú–ï–¢–†–´ –¢–ê–†–ò–§–û–í
# ============================================================================

TARIFF_PARAMS = [
    {
        "key": "name",
        "label": "–ù–∞–∑–≤–∞–Ω–∏–µ",
        "hint": "–Ω–∞–ø—Ä–∏–º–µ—Ä: –ú–µ—Å—è—Ü, –ü–æ–ª–≥–æ–¥–∞, –ì–æ–¥",
        "validate": lambda x: 1 <= len(x) <= 50,
        "error": "–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ç 1 –¥–æ 50 —Å–∏–º–≤–æ–ª–æ–≤"
    },
    {
        "key": "price_cents",
        "label": "–¶–µ–Ω–∞ (USDT)",
        "hint": "–≤ –¥–æ–ª–ª–∞—Ä–∞—Ö: 3.00, 5.50, 10",
        "validate": lambda x: (
            x.replace('.', '', 1).replace(',', '', 1).isdigit() and 
            0.01 <= float(x.replace(',', '.')) <= 1000.00
        ),
        "error": "–¶–µ–Ω–∞ –æ—Ç $0.01 –¥–æ $1000.00",
        "convert": lambda x: int(float(x.replace(',', '.')) * 100),
        "format": lambda x: f"${x / 100:.2f}"
    },
    {
        "key": "price_stars",
        "label": "–¶–µ–Ω–∞ (Stars)",
        "hint": "–≤ Telegram Stars (1-100000)",
        "validate": lambda x: x.isdigit() and 1 <= int(x) <= 100000,
        "error": "–¶–µ–Ω–∞ –æ—Ç 1 –¥–æ 100000 Stars",
        "convert": int,
        "format": lambda x: f"‚≠ê {x}"
    },
    {
        "key": "duration_days",
        "label": "–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å",
        "hint": "–≤ –¥–Ω—è—Ö (1-365)",
        "validate": lambda x: x.isdigit() and 1 <= int(x) <= 365,
        "error": "–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ—Ç 1 –¥–æ 365 –¥–Ω–µ–π",
        "convert": int,
        "format": lambda x: f"{x} –¥–Ω."
    },
    {
        "key": "external_id",
        "label": "ID —Ç–∞—Ä–∏—Ñ–∞ (Ya.Seller)",
        "hint": "–Ω–æ–º–µ—Ä —Ç–∞—Ä–∏—Ñ–∞ 1-9 –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Ç–æ–≤–∞—Ä–∞",
        "validate": lambda x: x.isdigit() and 1 <= int(x) <= 9,
        "error": "ID —Ç–∞—Ä–∏—Ñ–∞ –æ—Ç 1 –¥–æ 9",
        "convert": int,
        "crypto_only": True,  # –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã –∫—Ä–∏–ø—Ç–æ-–ø–ª–∞—Ç–µ–∂–∏
        "help": (
            "üí° –≠—Ç–æ –Ω–æ–º–µ—Ä —Ç–∞—Ä–∏—Ñ–∞ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Ç–æ–≤–∞—Ä–∞ Ya.Seller.\n"
            "–ü–æ –Ω–µ–º—É –±–æ—Ç –ø–æ–Ω–∏–º–∞–µ—Ç, –∑–∞ –∫–∞–∫–æ–π –∏–º–µ–Ω–Ω–æ —Ç–∞—Ä–∏—Ñ –ø–æ—Å—Ç—É–ø–∏–ª–∞ –æ–ø–ª–∞—Ç–∞.\n"
            "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ ID —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–∞—Ä–∏—Ñ–æ–º –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Ç–æ–≤–∞—Ä–∞!"
        )
    },
    {
        "key": "display_order",
        "label": "–ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è",
        "hint": "–º–µ–Ω—å—à–µ = –≤—ã—à–µ –≤ —Å–ø–∏—Å–∫–µ (0-99)",
        "validate": lambda x: x.isdigit() and 0 <= int(x) <= 99,
        "error": "–ü–æ—Ä—è–¥–æ–∫ –æ—Ç 0 –¥–æ 99",
        "convert": int
    },
]


def get_tariff_param_by_index(index: int, include_crypto: bool = True) -> dict:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä —Ç–∞—Ä–∏—Ñ–∞ –ø–æ –∏–Ω–¥–µ–∫—Å—É.
    
    Args:
        index: –ò–Ω–¥–µ–∫—Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
        include_crypto: –í–∫–ª—é—á–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∫—Ä–∏–ø—Ç–æ-–ø–ª–∞—Ç–µ–∂–µ–π
    """
    params = get_tariff_params_list(include_crypto)
    if 0 <= index < len(params):
        return params[index]
    return params[0] if params else TARIFF_PARAMS[0]


def get_tariff_params_list(include_crypto: bool = True) -> list:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ç–∞—Ä–∏—Ñ–∞.
    
    Args:
        include_crypto: –í–∫–ª—é—á–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∫—Ä–∏–ø—Ç–æ-–ø–ª–∞—Ç–µ–∂–µ–π
    """
    if include_crypto:
        return TARIFF_PARAMS
    return [p for p in TARIFF_PARAMS if not p.get('crypto_only')]


def get_total_tariff_params(include_crypto: bool = True) -> int:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ç–∞—Ä–∏—Ñ–∞."""
    return len(get_tariff_params_list(include_crypto))


# ============================================================================
# –ü–ê–†–ê–ú–ï–¢–†–´ –ö–†–ò–ü–¢–û-–ù–ê–°–¢–†–û–ï–ö
# ============================================================================

CRYPTO_PARAMS = [
    {
        "key": "crypto_item_url",
        "label": "–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä",
        "hint": "—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏–∑ @Ya\\_SellerBot",
        "validate": lambda x: x.startswith("https://t.me/Ya_SellerBot?start=item"),
        "error": "–°—Å—ã–ª–∫–∞ –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å https://t.me/Ya\\_SellerBot?start=item"
    },
    {
        "key": "crypto_secret_key",
        "label": "–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á",
        "hint": "–ü—Ä–æ—Ñ–∏–ª—å ‚Üí –ö–ª—é—á –ø–æ–¥–ø–∏—Å–∏ –≤ @Ya\\_SellerBot",
        "validate": lambda x: len(x) >= 16,
        "error": "–ö–ª—é—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 16 —Å–∏–º–≤–æ–ª–æ–≤"
    },
]


def get_crypto_param_by_index(index: int) -> dict:
    """–ü–æ–ª—É—á–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä –∫—Ä–∏–ø—Ç–æ-–Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ –∏–Ω–¥–µ–∫—Å—É."""
    if 0 <= index < len(CRYPTO_PARAMS):
        return CRYPTO_PARAMS[index]
    return CRYPTO_PARAMS[0]


def get_total_crypto_params() -> int:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫—Ä–∏–ø—Ç–æ-–Ω–∞—Å—Ç—Ä–æ–µ–∫."""
    return len(CRYPTO_PARAMS)

